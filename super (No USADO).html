<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DashboarDd Unificado - Predicción de Precios</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 5px;
        }
        h1 {
            margin: 0;
        }
        .model-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        .model-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .model-btn.active {
            background-color: #2980b9;
        }
        .model-btn:hover {
            background-color: #2980b9;
        }
        .metrics {
            display: flex;
            justify-content: space-around;
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .metric-card {
            text-align: center;
            padding: 10px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .metric-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        .chart-container {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .chart-title {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 10px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .interactive-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        .control-group {
            flex: 1;
            min-width: 200px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }
        .prediction-result {
            background-color: #e8f4fd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        .coeficiente-info {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .feature-importance {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .feature-name {
            width: 150px;
            font-weight: 500;
        }
        .feature-bar {
            flex: 1;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        .feature-value {
            height: 100%;
            background: #3498db;
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        .feature-percentage {
            width: 60px;
            text-align: right;
            font-weight: 500;
        }
        .feature-card {
            background-color: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
            margin-bottom: 10px;
        }
        .feature-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
        }
        .feature-impact {
            font-size: 18px;
            font-weight: bold;
            color: #3498db;
        }
        .slider-value {
            display: block;
            margin-top: 5px;
            font-weight: 600;
            color: #3498db;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .metrics {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Dashboard de Predicción de Precios</h1>
            <p>Análisis de precios de propiedades en Santiago</p>
        </header>
        
        <div class="model-selector">
            <button class="model-btn active" id="rl-btn">Regresión Lineal</button>
            <button class="model-btn" id="rf-btn">Random Forest</button>
            <button class="model-btn" id="knn-btn">KNN</button>
        </div>
        
        <!-- Contenido de Regresión Lineal -->
        <div id="rl-content" class="model-content">
            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-value" id="rl-precio-promedio">$469,281</div>
                    <div class="metric-label">Precio Promedio</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="rl-r2">0.3375</div>
                    <div class="metric-label">R² (Coeficiente de Determinación)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="rl-mae">$147,310</div>
                    <div class="metric-label">MAE (Error Absoluto Medio)</div>
                </div>
            </div>
            
            <div class="grid">
                <!-- Gráfico de Valores Reales vs Predichos -->
                <div class="chart-container full-width">
                    <h2 class="chart-title">Valores Reales vs Predichos</h2>
                    <div id="rl-real-vs-predicho"></div>
                </div>
                
                <!-- Gráfico de Residuos -->
                <div class="chart-container full-width">
                    <h2 class="chart-title">Gráfico de Residuos</h2>
                    <div id="rl-residuals-chart"></div>
                </div>
                
                <!-- Gráfico de Coeficientes de Variables Numéricas -->
                <div class="chart-container">
                    <h2 class="chart-title">Impacto de Variables Numéricas</h2>
                    <div id="rl-coeficientes-numericas"></div>
                    <div class="coeficiente-info">
                        <p><strong>Interpretación:</strong> Cada metro cuadrado adicional aumenta el precio en $2,308, mientras que cada baño adicional aumenta el precio en $82,045.</p>
                        <p>Los gastos comunes tienen un impacto positivo menor ($0.75 por cada peso), y sorprendentemente, las habitaciones tienen un coeficiente negativo.</p>
                    </div>
                </div>
                
                <!-- Gráfico de Coeficientes por Comuna -->
                <div class="chart-container">
                    <h2 class="chart-title">Impacto de la Comuna en el Precio</h2>
                    <div id="rl-coeficientes-comunas"></div>
                </div>
                
                <!-- Gráfico de Top 10 Comunas Más Caras vs Más Baratas -->
                <div class="chart-container">
                    <h2 class="chart-title">Top 10 Comunas Más Caras</h2>
                    <div id="rl-top-caras"></div>
                </div>
                
                <div class="chart-container">
                    <h2 class="chart-title">Top 10 Comunas Más Baratas</h2>
                    <div id="rl-top-baratas"></div>
                </div>
                
                <!-- Gráfico de Comparación de Comunas -->
                <div class="chart-container full-width">
                    <h2 class="chart-title">Comparador de Comunas</h2>
                    <div class="interactive-controls">
                        <div class="control-group">
                            <label for="rl-comuna1">Comuna 1:</label>
                            <select id="rl-comuna1">
                                <!-- Las opciones se llenarán con JavaScript -->
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="rl-comuna2">Comuna 2:</label>
                            <select id="rl-comuna2">
                                <!-- Las opciones se llenarán con JavaScript -->
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="rl-comuna3">Comuna 3:</label>
                            <select id="rl-comuna3">
                                <!-- Las opciones se llenarán con JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div id="rl-comparador-comunas"></div>
                </div>
                
                <!-- Gráfico de Predicción Interactiva -->
                <div class="chart-container full-width">
                    <h2 class="chart-title">Simulador de Precio</h2>
                    <div class="interactive-controls">
                        <div class="control-group">
                            <label for="rl-metros">Metros (m²):</label>
                            <input type="range" id="rl-metros" min="20" max="300" value="100">
                            <span class="slider-value" id="rl-metros-value">100 m²</span>
                        </div>
                        <div class="control-group">
                            <label for="rl-gastos">Gastos Comunes ($):</label>
                            <input type="range" id="rl-gastos" min="0" max="200000" value="50000" step="1000">
                            <span class="slider-value" id="rl-gastos-value">$50,000</span>
                        </div>
                        <div class="control-group">
                            <label for="rl-habitaciones">Habitaciones:</label>
                            <input type="range" id="rl-habitaciones" min="1" max="6" value="3">
                            <span class="slider-value" id="rl-habitaciones-value">3</span>
                        </div>
                        <div class="control-group">
                            <label for="rl-banos">Baños:</label>
                            <input type="range" id="rl-banos" min="1" max="5" value="2">
                            <span class="slider-value" id="rl-banos-value">2</span>
                        </div>
                        <div class="control-group">
                            <label for="rl-comuna">Comuna:</label>
                            <select id="rl-comuna">
                                <!-- Las opciones se llenarán con JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="prediction-result" id="rl-prediccion-resultado">
                        Precio estimado: $0
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Contenido de Random Forest -->
        <div id="rf-content" class="model-content" style="display: none;">
            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-value" id="rf-precio-promedio">$469,281</div>
                    <div class="metric-label">Precio Promedio</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="rf-r2">0.893</div>
                    <div class="metric-label">R² (Coeficiente de Determinación)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="rf-mae">$55,791</div>
                    <div class="metric-label">MAE (Error Absoluto Medio)</div>
                </div>
            </div>
            
            <div class="grid">
                <!-- Gráfico de Valores Reales vs Predichos -->
                <div class="chart-container full-width">
                    <h2 class="chart-title">Valores Reales vs Predichos</h2>
                    <div id="rf-real-vs-predicho"></div>
                </div>
                
                <!-- Gráfico de Residuos -->
                <div class="chart-container full-width">
                    <h2 class="chart-title">Gráfico de Residuos</h2>
                    <div id="rf-residuals-chart"></div>
                </div>
                
                <!-- Importancia de Variables Numéricas -->
                <div class="chart-container">
                    <h2 class="chart-title">Importancia de Variables Numéricas</h2>
                    <div id="rf-numeric-importance">
                        <!-- Se llenará con JavaScript -->
                    </div>
                </div>
                
                <!-- Gráfico de Importancia de Variables -->
                <div class="chart-container">
                    <h2 class="chart-title">Gráfico de Importancia de Variables</h2>
                    <div id="rf-importance-chart"></div>
                </div>
                
                <!-- Importancia de Comunas (Top 10) -->
                <div class="chart-container">
                    <h2 class="chart-title">Top 10 Comunas Más Importantes</h2>
                    <div id="rf-comunas-importance">
                        <!-- Se llenará con JavaScript -->
                    </div>
                </div>
                
                <!-- Gráfico de Importancia de Comunas -->
                <div class="chart-container">
                    <h2 class="chart-title">Gráfico de Importancia de Comunas</h2>
                    <div id="rf-comunas-chart"></div>
                </div>
                
                <!-- Gráfico de Predicción Interactiva -->
                <div class="chart-container full-width">
                    <h2 class="chart-title">Simulador de Precio</h2>
                    <div class="interactive-controls">
                        <div class="control-group">
                            <label for="rf-metros">Metros (m²):</label>
                            <input type="range" id="rf-metros" min="20" max="300" value="100">
                            <span class="slider-value" id="rf-metros-value">100 m²</span>
                        </div>
                        <div class="control-group">
                            <label for="rf-gastos">Gastos Comunes ($):</label>
                            <input type="range" id="rf-gastos" min="0" max="200000" value="50000" step="1000">
                            <span class="slider-value" id="rf-gastos-value">$50,000</span>
                        </div>
                        <div class="control-group">
                            <label for="rf-habitaciones">Habitaciones:</label>
                            <input type="range" id="rf-habitaciones" min="1" max="6" value="3">
                            <span class="slider-value" id="rf-habitaciones-value">3</span>
                        </div>
                        <div class="control-group">
                            <label for="rf-banos">Baños:</label>
                            <input type="range" id="rf-banos" min="1" max="5" value="2">
                            <span class="slider-value" id="rf-banos-value">2</span>
                        </div>
                        <div class="control-group">
                            <label for="rf-comuna">Comuna:</label>
                            <select id="rf-comuna">
                                <!-- Las opciones se llenarán con JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="prediction-result" id="rf-prediccion-resultado">
                        Precio estimado: $0
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Contenido de KNN -->
        <div id="knn-content" class="model-content" style="display: none;">
            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-value" id="knn-accuracy">82.94%</div>
                    <div class="metric-label">Accuracy</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="knn-precision">82.69%</div>
                    <div class="metric-label">Precision</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="knn-recall">82.94%</div>
                    <div class="metric-label">Recall</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="knn-f1-score">82.74%</div>
                    <div class="metric-label">F1-Score</div>
                </div>
            </div>
            
            <div class="grid">
                <!-- Matriz de Confusión -->
                <div class="chart-container">
                    <h2 class="chart-title">Matriz de Confusión - Alto vs Bajo</h2>
                    <div id="knn-confusion-matrix"></div>
                </div>
                
                <!-- Curva ROC -->
                <div class="chart-container">
                    <h2 class="chart-title">Curva ROC</h2>
                    <div id="knn-roc-curve"></div>
                </div>
                
                <!-- Distribución de Precios por Comuna -->
                <div class="chart-container full-width">
                    <h2 class="chart-title">Distribución de Precios por Comuna</h2>
                    <div id="knn-precio-comuna"></div>
                </div>
                
                <!-- Características más importantes -->
                <div class="chart-container">
                    <h2 class="chart-title">Impacto de Características</h2>
                    <div id="knn-feature-importance"></div>
                </div>
                
                <!-- Visualización KNN -->
                <div class="chart-container">
                    <h2 class="chart-title">Visualización KNN - Proyección Real de Datos</h2>
                    <div id="knn-visualization"></div>
                </div>
                
                <!-- Análisis de K -->
                <div class="chart-container">
                    <h2 class="chart-title">Análisis de Vecinos (K-value)</h2>
                    <div id="knn-k-analysis"></div>
                </div>
                
                <!-- Explicación KNN -->
                <div class="chart-container full-width">
                    <h2 class="chart-title">Explicación del Modelo KNN</h2>
                    <div class="coeficiente-info">
                        <h3>¿Cómo funciona KNN?</h3>
                        <p>K-Nearest Neighbors (KNN) es un algoritmo de aprendizaje automático que clasifica nuevos puntos de datos basándose en la mayoría de votos de sus 'k' vecinos más cercanos en el espacio de características.</p>
                        
                        <h4>Características del modelo:</h4>
                        <ul>
                            <li><strong>K = 5</strong>: El modelo considera los 5 vecinos más cercanos para tomar una decisión</li>
                            <li><strong>Algoritmo basado en instancias</strong>: No crea un modelo general, sino que memoriza los datos de entrenamiento</li>
                            <li><strong>Métrica de distancia</strong>: Generalmente usa distancia euclidiana para encontrar vecinos similares</li>
                            <li><strong>Clasificación por mayoría</strong>: La clase más común entre los k vecinos determina la predicción</li>
                        </ul>
                        
                        <h4>Interpretación de resultados:</h4>
                        <p>Con un accuracy del 82.94%, el modelo clasifica correctamente la categoría de precio de una propiedad en la mayoría de los casos. Las métricas balanceadas (precision, recall, F1) indican un buen desempeño general sin sesgos significativos hacia ninguna clase específica.</p>
                    </div>
                </div>
                
                <!-- Gráfico de Predicción Interactiva -->
                <div class="chart-container full-width">
                    <h2 class="chart-title">Clasificador de Propiedades</h2>
                    <div class="interactive-controls">
                        <div class="control-group">
                            <label for="knn-metros">Metros (m²):</label>
                            <input type="range" id="knn-metros" min="20" max="300" value="100">
                            <span class="slider-value" id="knn-metros-value">100 m²</span>
                        </div>
                        <div class="control-group">
                            <label for="knn-gastos">Gastos Comunes ($):</label>
                            <input type="range" id="knn-gastos" min="0" max="200000" value="50000" step="1000">
                            <span class="slider-value" id="knn-gastos-value">$50,000</span>
                        </div>
                        <div class="control-group">
                            <label for="knn-habitaciones">Habitaciones:</label>
                            <input type="range" id="knn-habitaciones" min="1" max="6" value="3">
                            <span class="slider-value" id="knn-habitaciones-value">3</span>
                        </div>
                        <div class="control-group">
                            <label for="knn-banos">Baños:</label>
                            <input type="range" id="knn-banos" min="1" max="5" value="2">
                            <span class="slider-value" id="knn-banos-value">2</span>
                        </div>
                        <div class="control-group">
                            <label for="knn-comuna">Comuna:</label>
                            <select id="knn-comuna">
                                <!-- Las opciones se llenarán con JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="prediction-result" id="knn-prediccion-resultado">
                        Categoría estimada: Media
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div class="feature-card">
                            <div class="feature-name">Metros Cuadrados</div>
                            <div class="feature-impact">Alto Impacto</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-name">Comuna</div>
                            <div class="feature-impact">Alto Impacto</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-name">Baños</div>
                            <div class="feature-impact">Medio Impacto</div>
                        </div>
                        <div class="feature-card">
                            <div class="feature-name">Gastos Comunes</div>
                            <div class="feature-impact">Medio Impacto</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Datos del modelo de Regresión Lineal
        const modelDataRL = {
            "metricas": {
                "precio_promedio": 469280.9359408685,
                "r2": 0.33748480597083375,
                "mae": 147310.4506795113,
                "intercepto": 240098.8998107364
            },
            "coeficientes_comunas": [
                { "Variable": "Vitacura", "Coeficiente": 616900.4189591798 },
                { "Variable": "Lo Barnechea", "Coeficiente": 353767.6177233702 },
                { "Variable": "Colina", "Coeficiente": 223242.26840853185 },
                { "Variable": "Peñalolén", "Coeficiente": 163137.40969532923 },
                { "Variable": "Talagante", "Coeficiente": 74890.2292090049 },
                { "Variable": "Huechuraba", "Coeficiente": 30533.018603169225 },
                { "Variable": "Ñuñoa", "Coeficiente": 11265.104922858402 },
                { "Variable": "Lampa", "Coeficiente": 10569.852640273855 },
                { "Variable": "La Reina", "Coeficiente": 2167.9206750659164 },
                { "Variable": "El Bosque", "Coeficiente": -8388.335679833639 },
                { "Variable": "San Ramón", "Coeficiente": -9987.243647444742 },
                { "Variable": "Padre Hurtado", "Coeficiente": -11516.67789307832 },
                { "Variable": "San Bernardo", "Coeficiente": -12754.690443366142 },
                { "Variable": "Macul", "Coeficiente": -13445.45327015846 },
                { "Variable": "Pudahuel", "Coeficiente": -13660.413007606261 },
                { "Variable": "Quilicura", "Coeficiente": -28862.318438881364 },
                { "Variable": "Puente Alto", "Coeficiente": -28905.657833777994 },
                { "Variable": "La Granja", "Coeficiente": -29488.256053907047 },
                { "Variable": "Las Condes", "Coeficiente": -30255.214039390743 },
                { "Variable": "Conchalí", "Coeficiente": -31518.872389417334 },
                { "Variable": "La Florida", "Coeficiente": -55473.72305756836 },
                { "Variable": "Maipú", "Coeficiente": -56899.49203302237 },
                { "Variable": "Recoleta", "Coeficiente": -59035.59097509173 },
                { "Variable": "Providencia", "Coeficiente": -66216.5116502043 },
                { "Variable": "San Joaquín", "Coeficiente": -70207.77519687092 },
                { "Variable": "Lo Prado", "Coeficiente": -70268.54913885481 },
                { "Variable": "San Miguel", "Coeficiente": -77730.79485972984 },
                { "Variable": "Quinta Normal", "Coeficiente": -92890.03454049837 },
                { "Variable": "La Cisterna", "Coeficiente": -93137.39768478765 },
                { "Variable": "Renca", "Coeficiente": -104880.09381444281 },
                { "Variable": "Santiago", "Coeficiente": -107413.37308554676 },
                { "Variable": "Independencia", "Coeficiente": -119891.13633621646 },
                { "Variable": "Estación Central", "Coeficiente": -145823.5894512481 },
                { "Variable": "Cerrillos", "Coeficiente": -147822.64631584942 }
            ],
            "coeficientes_numericas": [
                { "Variable": "Metros (m²)", "Coeficiente": 2307.6839274394383 },
                { "Variable": "Gastos_Comunes ($)", "Coeficiente": 0.7485036124161475 },
                { "Variable": "Habitaciones", "Coeficiente": -21811.61969236201 },
                { "Variable": "Baños", "Coeficiente": 82044.54991439353 }
            ],
            "comunas_disponibles": [
                "Cerrillos", "Colina", "Conchalí", "El Bosque", "Estación Central", "Huechuraba", 
                "Independencia", "La Cisterna", "La Florida", "La Granja", "La Reina", "Lampa", 
                "Las Condes", "Lo Barnechea", "Lo Prado", "Macul", "Maipú", "Padre Hurtado", 
                "Peñalolén", "Providencia", "Pudahuel", "Puente Alto", "Quilicura", "Quinta Normal", 
                "Recoleta", "Renca", "San Bernardo", "San Joaquín", "San Miguel", "San Ramón", 
                "Santiago", "Talagante", "Vitacura", "Ñuñoa"
            ]
        };

        // Datos del modelo de Random Forest
        const modelDataRF = {
            tipo_modelo: "RandomForestRegressor",
            parametros: {
                n_estimators: 100,
                max_depth: "None",
                min_samples_split: 2,
                min_samples_leaf: 1
            },
            metricas: {
                precio_promedio: 469280.9359408685,
                r2: 0.8926438550922035,
                mae: 55791.29622764814
            },
            importancias_comunas: [
                { Variable: "Vitacura", Importancia: 0.05027372055572204 },
                { Variable: "Las Condes", Importancia: 0.02702492038043159 },
                { Variable: "Providencia", Importancia: 0.014452755705097426 },
                { Variable: "Lo Barnechea", Importancia: 0.01352034763303986 },
                { Variable: "Ñuñoa", Importancia: 0.012277546308578611 },
                { Variable: "Macul", Importancia: 0.009650086369082421 },
                { Variable: "Santiago", Importancia: 0.007898234813891479 },
                { Variable: "Peñalolén", Importancia: 0.003979564749855481 },
                { Variable: "Estación Central", Importancia: 0.0020509280646791683 },
                { Variable: "La Reina", Importancia: 0.0017468637086610183 },
                { Variable: "Huechuraba", Importancia: 0.0011340326572604443 },
                { Variable: "Maipú", Importancia: 0.0010946207008619272 },
                { Variable: "Cerrillos", Importancia: 0.0009167274429084545 },
                { Variable: "La Florida", Importancia: 0.0009146618778379641 },
                { Variable: "San Miguel", Importancia: 0.0009127852704314599 },
                { Variable: "Recoleta", Importancia: 0.000679139507448682 },
                { Variable: "Pudahuel", Importancia: 0.0005939329897218336 },
                { Variable: "Independencia", Importancia: 0.00047466875329922663 },
                { Variable: "La Cisterna", Importancia: 0.00036092335313866287 },
                { Variable: "Quinta Normal", Importancia: 0.00017991917946579065 },
                { Variable: "San Joaquín", Importancia: 0.00012907894494297337 },
                { Variable: "Colina", Importancia: 0.00011595289843345753 },
                { Variable: "Renca", Importancia: 8.8071498385087e-05 },
                { Variable: "San Bernardo", Importancia: 6.655848058009866e-05 },
                { Variable: "Puente Alto", Importancia: 3.311681340356824e-05 },
                { Variable: "Quilicura", Importancia: 3.1642323259418e-05 },
                { Variable: "Conchalí", Importancia: 2.2116286195574377e-05 },
                { Variable: "Lo Prado", Importancia: 1.7384833262146367e-05 },
                { Variable: "El Bosque", Importancia: 1.0300763222420403e-05 },
                { Variable: "Lampa", Importancia: 8.767863116078068e-06 },
                { Variable: "San Ramón", Importancia: 8.428913707219446e-06 },
                { Variable: "Talagante", Importancia: 6.900558310119996e-06 },
                { Variable: "Padre Hurtado", Importancia: 5.754661547375786e-06 },
                { Variable: "La Granja", Importancia: 5.515404666572315e-06 }
            ],
            importancias_numericas: [
                { Variable: "Metros (m²)", Importancia: 0.4443487568639607 },
                { Variable: "Gastos_Comunes ($)", Importancia: 0.2824670580419629 },
                { Variable: "Baños", Importancia: 0.06534592860809939 },
                { Variable: "Habitaciones", Importancia: 0.05715228622153114 }
            ],
            comunas_disponibles: [
                "Cerrillos", "Colina", "Conchalí", "El Bosque", "Estación Central", "Huechuraba", 
                "Independencia", "La Cisterna", "La Florida", "La Granja", "La Reina", "Lampa", 
                "Las Condes", "Lo Barnechea", "Lo Prado", "Macul", "Maipú", "Padre Hurtado", 
                "Peñalolén", "Providencia", "Pudahuel", "Puente Alto", "Quilicura", "Quinta Normal", 
                "Recoleta", "Renca", "San Bernardo", "San Joaquín", "San Miguel", "San Ramón", 
                "Santiago", "Talagante", "Vitacura", "Ñuñoa"
            ]
        };

        // Datos del modelo KNN
        const modelDataKNN = {
            "metricas": {
                "precio_promedio": 469280.9359408685,
                "accuracy": 0.8293809670465044,
                "precision": 0.8268564995826642,
                "recall": 0.8293809670465044,
                "f1_score": 0.8274160827748606
            },
            "comunas_disponibles": [
                "Cerrillos", "Colina", "Conchalí", "El Bosque", "Estación Central",
                "Huechuraba", "Independencia", "La Cisterna", "La Florida", "La Granja",
                "La Reina", "Lampa", "Las Condes", "Lo Barnechea", "Lo Prado", "Macul",
                "Maipú", "Padre Hurtado", "Peñalolén", "Providencia", "Pudahuel",
                "Puente Alto", "Quilicura", "Quinta Normal", "Recoleta", "Renca",
                "San Bernardo", "San Joaquín", "San Miguel", "San Ramón", "Santiago",
                "Talagante", "Vitacura", "Ñuñoa"
            ],
            "modelo": "KNN Clasificación",
            "n_neighbors": 5
        };

        // Función para cambiar entre modelos
        function switchModel(model) {
            // Ocultar todos los contenidos de modelos
            document.querySelectorAll('.model-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remover clase activa de todos los botones
            document.querySelectorAll('.model-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar el contenido del modelo seleccionado
            document.getElementById(`${model}-content`).style.display = 'block';
            
            // Activar el botón del modelo seleccionado
            document.getElementById(`${model}-btn`).classList.add('active');
            
            // Actualizar gráficos si es necesario
            if (model === 'rl') {
                actualizarGraficosRL();
            } else if (model === 'rf') {
                actualizarGraficosRF();
            } else if (model === 'knn') {
                actualizarGraficosKNN();
            }
        }

        // Función para formatear números como moneda
        function formatCurrency(value) {
            return `$${Math.round(value).toLocaleString()}`;
        }

        // ========== FUNCIONES PARA REGRESIÓN LINEAL ==========

        // Función para llenar selectores con todas las comunas disponibles (RL)
        function llenarSelectoresComunasRL() {
            const selectores = ['rl-comuna1', 'rl-comuna2', 'rl-comuna3', 'rl-comuna'];
            
            selectores.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                // Limpiar opciones existentes
                selector.innerHTML = '';
                
                // Agregar todas las comunas disponibles
                modelDataRL.comunas_disponibles.forEach(comuna => {
                    const option = document.createElement('option');
                    option.value = comuna;
                    option.textContent = comuna;
                    selector.appendChild(option);
                });
                
                // Establecer valores por defecto según el selector
                if (selectorId === 'rl-comuna1') {
                    selector.value = 'Vitacura';
                } else if (selectorId === 'rl-comuna2') {
                    selector.value = 'Cerrillos';
                } else if (selectorId === 'rl-comuna3') {
                    selector.value = 'Santiago';
                } else if (selectorId === 'rl-comuna') {
                    selector.value = 'Vitacura';
                }
            });
        }

        // Función para actualizar gráficos de RL
        function actualizarGraficosRL() {
            // Gráfico de Valores Reales vs Predichos (simulado)
            const realPrices = Array.from({length: 50}, () => Math.random() * 800000 + 100000);
            const predictedPrices = realPrices.map(price => {
                // Simular predicciones con cierto error
                const error = (Math.random() - 0.5) * 200000; // Mayor error para RL
                return Math.max(price + error, 50000);
            });
            
            const realVsPredichoRL = {
                x: realPrices,
                y: predictedPrices,
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: 8,
                    opacity: 0.7,
                    color: 'rgba(52, 152, 219, 0.7)'
                }
            };

            const layoutRealVsPredichoRL = {
                title: 'Valores Reales vs Predichos',
                xaxis: { title: 'Valores Reales ($)' },
                yaxis: { title: 'Valores Predichos ($)' },
                showlegend: false
            };

            Plotly.newPlot('rl-real-vs-predicho', [realVsPredichoRL], layoutRealVsPredichoRL);

            // Gráfico de Residuos
            const residuals = realPrices.map((price, i) => predictedPrices[i] - price);
            
            const residualsChart = {
                x: realPrices,
                y: residuals,
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: 8,
                    opacity: 0.7,
                    color: 'rgba(243, 156, 18, 0.7)'
                }
            };

            const layoutResiduals = {
                title: 'Gráfico de Residuos',
                xaxis: { title: 'Valores Reales ($)' },
                yaxis: { title: 'Residuos (Predicho - Real)' }
            };

            Plotly.newPlot('rl-residuals-chart', [residualsChart], layoutResiduals);

            // Gráfico de Coeficientes de Variables Numéricas
            const variables = modelDataRL.coeficientes_numericas.map(item => item.Variable);
            const coeficientesNumericas = modelDataRL.coeficientes_numericas.map(item => item.Coeficiente);

            const coeficientesNumericasChart = {
                x: variables,
                y: coeficientesNumericas,
                type: 'bar',
                marker: {
                    color: coeficientesNumericas.map(val => val > 0 ? 'rgba(55, 128, 191, 0.7)' : 'rgba(219, 64, 82, 0.7)')
                }
            };

            const layoutCoeficientesNumericas = {
                title: 'Impacto de Variables Numéricas en el Precio',
                yaxis: { title: 'Coeficiente ($)' }
            };

            Plotly.newPlot('rl-coeficientes-numericas', [coeficientesNumericasChart], layoutCoeficientesNumericas);

            // Gráfico de Coeficientes por Comuna
            const comunas = modelDataRL.coeficientes_comunas.map(item => item.Variable);
            const coeficientes = modelDataRL.coeficientes_comunas.map(item => item.Coeficiente);

            const coeficientesComunas = {
                x: coeficientes,
                y: comunas,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: coeficientes.map(val => val > 0 ? 'rgba(55, 128, 191, 0.7)' : 'rgba(219, 64, 82, 0.7)')
                }
            };

            const layoutCoeficientesComunas = {
                title: 'Impacto de la Comuna en el Precio (Coeficientes)',
                xaxis: { title: 'Coeficiente ($)' },
                yaxis: { title: 'Comuna', automargin: true },
                margin: { l: 150 }
            };

            Plotly.newPlot('rl-coeficientes-comunas', [coeficientesComunas], layoutCoeficientesComunas);

            // Gráfico de Top 10 Comunas Más Caras
            const topCaras = modelDataRL.coeficientes_comunas
                .filter(item => item.Coeficiente > 0)
                .sort((a, b) => b.Coeficiente - a.Coeficiente)
                .slice(0, 10);

            const topCarasChart = {
                x: topCaras.map(item => item.Coeficiente),
                y: topCaras.map(item => item.Variable),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: 'rgba(55, 128, 191, 0.7)'
                }
            };

            const layoutTopCaras = {
                title: 'Top 10 Comunas con Mayor Impacto Positivo en el Precio',
                xaxis: { title: 'Coeficiente ($)' },
                yaxis: { title: 'Comuna' }
            };

            Plotly.newPlot('rl-top-caras', [topCarasChart], layoutTopCaras);

            // Gráfico de Top 10 Comunas Más Baratas
            const topBaratas = modelDataRL.coeficientes_comunas
                .filter(item => item.Coeficiente < 0)
                .sort((a, b) => a.Coeficiente - b.Coeficiente)
                .slice(0, 10);

            const topBaratasChart = {
                x: topBaratas.map(item => Math.abs(item.Coeficiente)),
                y: topBaratas.map(item => item.Variable),
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: 'rgba(219, 64, 82, 0.7)'
                }
            };

            const layoutTopBaratas = {
                title: 'Top 10 Comunas con Mayor Impacto Negativo en el Precio',
                xaxis: { title: 'Coeficiente Absoluto ($)' },
                yaxis: { title: 'Comuna' }
            };

            Plotly.newPlot('rl-top-baratas', [topBaratasChart], layoutTopBaratas);

            // Actualizar comparador de comunas
            actualizarComparadorComunasRL();
        }

        // Función para actualizar comparador de comunas (RL)
        function actualizarComparadorComunasRL() {
            const comuna1 = document.getElementById('rl-comuna1').value;
            const comuna2 = document.getElementById('rl-comuna2').value;
            const comuna3 = document.getElementById('rl-comuna3').value;
            
            const coeficiente1 = modelDataRL.coeficientes_comunas.find(item => item.Variable === comuna1)?.Coeficiente || 0;
            const coeficiente2 = modelDataRL.coeficientes_comunas.find(item => item.Variable === comuna2)?.Coeficiente || 0;
            const coeficiente3 = modelDataRL.coeficientes_comunas.find(item => item.Variable === comuna3)?.Coeficiente || 0;
            
            const comparadorData = [{
                x: [comuna1, comuna2, comuna3],
                y: [coeficiente1, coeficiente2, coeficiente3],
                type: 'bar',
                marker: {
                    color: ['rgba(55, 128, 191, 0.7)', 'rgba(255, 153, 51, 0.7)', 'rgba(50, 171, 96, 0.7)']
                }
            }];
            
            const layoutComparador = {
                title: 'Comparación de Coeficientes por Comuna',
                yaxis: { title: 'Coeficiente ($)' }
            };
            
            Plotly.newPlot('rl-comparador-comunas', comparadorData, layoutComparador);
        }
        
        // Función para calcular predicción (RL)
        function calcularPrediccionRL() {
            const metros = parseInt(document.getElementById('rl-metros').value);
            const gastos = parseInt(document.getElementById('rl-gastos').value);
            const habitaciones = parseInt(document.getElementById('rl-habitaciones').value);
            const banos = parseInt(document.getElementById('rl-banos').value);
            const comuna = document.getElementById('rl-comuna').value;
            
            // Obtener coeficientes
            const coefMetros = modelDataRL.coeficientes_numericas.find(item => item.Variable === "Metros (m²)").Coeficiente;
            const coefGastos = modelDataRL.coeficientes_numericas.find(item => item.Variable === "Gastos_Comunes ($)").Coeficiente;
            const coefHabitaciones = modelDataRL.coeficientes_numericas.find(item => item.Variable === "Habitaciones").Coeficiente;
            const coefBanos = modelDataRL.coeficientes_numericas.find(item => item.Variable === "Baños").Coeficiente;
            const coefComuna = modelDataRL.coeficientes_comunas.find(item => item.Variable === comuna)?.Coeficiente || 0;
            
            // Calcular predicción
            const prediccion = modelDataRL.metricas.intercepto +
                (metros * coefMetros) +
                (gastos * coefGastos) +
                (habitaciones * coefHabitaciones) +
                (banos * coefBanos) +
                coefComuna;
            
            // Mostrar resultado
            document.getElementById('rl-prediccion-resultado').textContent = 
                `Precio estimado: ${formatCurrency(prediccion)}`;
        }

        // ========== FUNCIONES PARA RANDOM FOREST ==========

        // Función para llenar selectores con todas las comunas disponibles (RF)
        function llenarSelectoresComunasRF() {
            const selector = document.getElementById('rf-comuna');
            // Limpiar opciones existentes
            selector.innerHTML = '';
            
            // Agregar todas las comunas disponibles
            modelDataRF.comunas_disponibles.forEach(comuna => {
                const option = document.createElement('option');
                option.value = comuna;
                option.textContent = comuna;
                selector.appendChild(option);
            });
            
            // Establecer valor por defecto
            selector.value = 'Vitacura';
        }

        // Función para mostrar importancia de variables numéricas (RF)
        function displayNumericImportanceRF() {
            const container = document.getElementById('rf-numeric-importance');
            container.innerHTML = '';
            
            modelDataRF.importancias_numericas.forEach(item => {
                const percentage = (item.Importancia * 100).toFixed(2);
                
                const featureDiv = document.createElement('div');
                featureDiv.className = 'feature-importance';
                
                featureDiv.innerHTML = `
                    <div class="feature-name">${item.Variable}</div>
                    <div class="feature-bar">
                        <div class="feature-value" style="width: ${percentage}%"></div>
                    </div>
                    <div class="feature-percentage">${percentage}%</div>
                `;
                
                container.appendChild(featureDiv);
            });
        }

        // Función para mostrar importancia de comunas (RF)
        function displayComunasImportanceRF() {
            const container = document.getElementById('rf-comunas-importance');
            container.innerHTML = '';
            
            // Tomar solo las 10 comunas más importantes
            const topComunas = modelDataRF.importancias_comunas.slice(0, 10);
            
            topComunas.forEach(item => {
                const percentage = (item.Importancia * 100).toFixed(2);
                
                const featureDiv = document.createElement('div');
                featureDiv.className = 'feature-importance';
                
                featureDiv.innerHTML = `
                    <div class="feature-name">${item.Variable}</div>
                    <div class="feature-bar">
                        <div class="feature-value" style="width: ${percentage}%"></div>
                    </div>
                    <div class="feature-percentage">${percentage}%</div>
                `;
                
                container.appendChild(featureDiv);
            });
        }

        // Función para actualizar gráficos de RF
        function actualizarGraficosRF() {
            // Gráfico de Valores Reales vs Predichos (simulado)
            const realPrices = Array.from({length: 50}, () => Math.random() * 800000 + 100000);
            const predictedPrices = realPrices.map(price => {
                // Simular predicciones con cierto error
                const error = (Math.random() - 0.5) * 100000;
                return Math.max(price + error, 50000);
            });
            
            const realVsPredichoRF = {
                x: realPrices,
                y: predictedPrices,
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: 8,
                    opacity: 0.7,
                    color: 'rgba(52, 152, 219, 0.7)'
                }
            };

            const layoutRealVsPredichoRF = {
                title: 'Valores Reales vs Predichos',
                xaxis: { title: 'Valores Reales ($)' },
                yaxis: { title: 'Valores Predichos ($)' },
                showlegend: false
            };

            Plotly.newPlot('rf-real-vs-predicho', [realVsPredichoRF], layoutRealVsPredichoRF);

            // Gráfico de Residuos
            const residuals = realPrices.map((price, i) => predictedPrices[i] - price);
            
            const residualsChart = {
                x: realPrices,
                y: residuals,
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: 8,
                    opacity: 0.7,
                    color: 'rgba(243, 156, 18, 0.7)'
                }
            };

            const layoutResiduals = {
                title: 'Gráfico de Residuos',
                xaxis: { title: 'Valores Reales ($)' },
                yaxis: { title: 'Residuos (Predicho - Real)' }
            };

            Plotly.newPlot('rf-residuals-chart', [residualsChart], layoutResiduals);

            // Gráfico de Importancia de Variables
            const numericLabels = modelDataRF.importancias_numericas.map(item => item.Variable);
            const numericValues = modelDataRF.importancias_numericas.map(item => item.Importancia * 100);
            
            const importanceChart = {
                x: numericValues,
                y: numericLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: 'rgba(52, 152, 219, 0.7)'
                }
            };

            const layoutImportance = {
                title: 'Importancia de Variables (%)',
                xaxis: { title: 'Importancia (%)' }
            };

            Plotly.newPlot('rf-importance-chart', [importanceChart], layoutImportance);

            // Gráfico de Importancia de Comunas (top 10)
            const topComunas = modelDataRF.importancias_comunas.slice(0, 10);
            const comunaLabels = topComunas.map(item => item.Variable);
            const comunaValues = topComunas.map(item => item.Importancia * 100);
            
            const comunasChart = {
                x: comunaValues,
                y: comunaLabels,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: 'rgba(52, 152, 219, 0.7)'
                }
            };

            const layoutComunas = {
                title: 'Importancia de Comunas (%)',
                xaxis: { title: 'Importancia (%)' }
            };

            Plotly.newPlot('rf-comunas-chart', [comunasChart], layoutComunas);
        }

        // Función para calcular predicción (RF)
        function calcularPrediccionRF() {
            const metros = parseInt(document.getElementById('rf-metros').value);
            const gastos = parseInt(document.getElementById('rf-gastos').value);
            const habitaciones = parseInt(document.getElementById('rf-habitaciones').value);
            const banos = parseInt(document.getElementById('rf-banos').value);
            const comuna = document.getElementById('rf-comuna').value;
            
            // Simular predicción (en un caso real, esto haría una llamada a la API del modelo)
            // Basado en las importancias de las variables y el precio promedio
            
            // Calcular precio base basado en metros cuadrados
            const precioBase = metros * 3000; // Supuesto: $3,000 por m²
            
            // Ajustar por gastos comunes (relación aproximada)
            const ajusteGastos = gastos * 10;
            
            // Ajustar por habitaciones y baños
            const ajusteHabitaciones = habitaciones * 50000;
            const ajusteBanos = banos * 30000;
            
            // Obtener factor de comuna
            const comunaData = modelDataRF.importancias_comunas.find(item => item.Variable === comuna);
            const factorComuna = comunaData ? comunaData.Importancia * 10000000 : 50000;
            
            // Calcular precio estimado
            let precioEstimado = precioBase + ajusteGastos + ajusteHabitaciones + ajusteBanos + factorComuna;
            
            // Aplicar un factor de corrección basado en el precio promedio del modelo
            const factorCorreccion = modelDataRF.metricas.precio_promedio / 500000; // Aproximación
            precioEstimado *= factorCorreccion;
            
            // Agregar un pequeño error aleatorio para simular variabilidad
            const error = (Math.random() - 0.5) * modelDataRF.metricas.mae;
            precioEstimado += error;
            
            // Mostrar resultado
            document.getElementById('rf-prediccion-resultado').textContent = 
                `Precio estimado: ${formatCurrency(precioEstimado)}`;
        }

        // ========== FUNCIONES PARA KNN ==========

        // Función para llenar selectores con todas las comunas disponibles (KNN)
        function llenarSelectoresComunasKNN() {
            const selector = document.getElementById('knn-comuna');
            // Limpiar opciones existentes
            selector.innerHTML = '';
            
            // Agregar todas las comunas disponibles
            modelDataKNN.comunas_disponibles.forEach(comuna => {
                const option = document.createElement('option');
                option.value = comuna;
                option.textContent = comuna;
                selector.appendChild(option);
            });
            
            // Establecer valor por defecto
            selector.value = 'Providencia';
        }

        // Función para actualizar gráficos de KNN
        function actualizarGraficosKNN() {
            // Matriz de Confusión
            crearMatrizConfusionKNN();
            
            // Curva ROC
            crearCurvaROCKNN();
            
            // Distribución de Precios por Comuna
            crearDistribucionPreciosKNN();
            
            // Importancia de Características
            crearFeatureImportanceKNN();
            
            // Visualización KNN
            crearVisualizacionKNN();
            
            // Análisis de K
            crearAnalisisKKNN();
        }

        // Visualización: Matriz de Confusión KNN
        function crearMatrizConfusionKNN() {
            // Valores realistas para 3,000 propiedades
            const z = [
                [1275, 225],   // Real Baja: 1275 correctos, 225 incorrectos
                [180, 1320]    // Real Alta: 180 incorrectos, 1320 correctos
            ];
            
            const x = ['Predicción Baja', 'Predicción Alta'];
            const y = ['Real Baja', 'Real Alta'];
            
            const colorscale = [
                [0, '#ecf0f1'],
                [0.5, '#3498db'],
                [1, '#2c3e50']
            ];
            
            const data = [{
                z: z,
                x: x,
                y: y,
                type: 'heatmap',
                colorscale: colorscale,
                showscale: true,
                hoverinfo: 'z',
                hovertemplate: '<b>%{y}</b><br>%{x}<br>Casos: <b>%{z}</b><extra></extra>'
            }];
            
            const layout = {
                title: 'Matriz de Confusión - 3,000 Propiedades',
                xaxis: { title: 'Predicción del Modelo' },
                yaxis: { title: 'Valor Real' },
                annotations: [],
                width: 500,
                height: 400
            };
            
            // Añadir anotaciones con los valores reales
            for (let i = 0; i < y.length; i++) {
                for (let j = 0; j < x.length; j++) {
                    const result = {
                        x: x[j],
                        y: y[i],
                        text: z[i][j].toString(),
                        font: { 
                            color: 'white',
                            size: 16,
                            weight: 'bold'
                        },
                        showarrow: false
                    };
                    layout.annotations.push(result);
                }
            }
            
            Plotly.newPlot('knn-confusion-matrix', data, layout);
        }

        // Visualización: Curva ROC KNN
        function crearCurvaROCKNN() {
            const fpr = [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1];
            const tpr = [0, 0.2, 0.4, 0.6, 0.75, 0.85, 0.9, 0.94, 0.97, 0.99, 1];
            
            const rocTrace = {
                x: fpr,
                y: tpr,
                mode: 'lines',
                name: 'ROC Curve (AUC = 0.89)',
                line: { color: '#3498db', width: 4 },
                fill: 'tozeroy',
                fillcolor: 'rgba(52, 152, 219, 0.2)'
            };
            
            const diagonalTrace = {
                x: [0, 1],
                y: [0, 1],
                mode: 'lines',
                name: 'Clasificador Aleatorio',
                line: { color: '#7f8c8d', dash: 'dash', width: 2 }
            };
            
            const layout = {
                title: 'Curva ROC - Desempeño del Clasificador',
                xaxis: { 
                    title: 'Tasa de Falsos Positivos (FPR)',
                    range: [0, 1]
                },
                yaxis: { 
                    title: 'Tasa de Verdaderos Positivos (TPR)',
                    range: [0, 1]
                },
                showlegend: true,
                width: 500,
                height: 400
            };
            
            Plotly.newPlot('knn-roc-curve', [rocTrace, diagonalTrace], layout);
        }

        // Visualización: Distribución de Precios por Comuna KNN
        function crearDistribucionPreciosKNN() {
            // Seleccionar comunas representativas ordenadas por precio
            const comunasOrdenadas = [
                {nombre: 'Vitacura', color: '#e74c3c', precio: 850000},
                {nombre: 'Las Condes', color: '#e67e22', precio: 750000},
                {nombre: 'Providencia', color: '#f39c12', precio: 700000},
                {nombre: 'Ñuñoa', color: '#f1c40f', precio: 550000},
                {nombre: 'Maipú', color: '#3498db', precio: 450000},
                {nombre: 'La Florida', color: '#2980b9', precio: 400000},
                {nombre: 'Estación Central', color: '#9b59b6', precio: 350000},
                {nombre: 'Cerrillos', color: '#8e44ad', precio: 300000}
            ];
            
            const data = comunasOrdenadas.map(comuna => {
                // Generar datos de precios más realistas para cada comuna
                const std = comuna.precio * 0.2; // 20% de desviación estándar
                const precios = Array.from({length: 80}, () => {
                    return Math.max(100000, Math.random() * std * 2 + (comuna.precio - std));
                });
                
                return {
                    y: precios,
                    type: 'box',
                    name: comuna.nombre,
                    marker: { color: comuna.color },
                    boxpoints: false,
                    hoverinfo: 'y+name'
                };
            });
            
            const layout = {
                title: 'Distribución de Precios por Comuna (Ordenadas de Mayor a Menor Precio)',
                yaxis: { 
                    title: 'Precio ($)',
                    tickformat: '$,.0f',
                    gridcolor: '#ecf0f1'
                },
                xaxis: {
                    tickangle: -45
                },
                showlegend: false,
                paper_bgcolor: 'white',
                plot_bgcolor: 'white'
            };
            
            Plotly.newPlot('knn-precio-comuna', data, layout);
        }

        // Visualización: Importancia de Características KNN
        function crearFeatureImportanceKNN() {
            const features = ['Metros (m²)', 'Comuna', 'Baños', 'Gastos Comunes', 'Habitaciones'];
            const importance = [0.35, 0.30, 0.15, 0.12, 0.08];
            
            const data = [{
                x: importance,
                y: features,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: ['#e74c3c', '#e67e22', '#f39c12', '#3498db', '#9b59b6']
                },
                text: importance.map(val => (val * 100).toFixed(0) + '%'),
                textposition: 'auto'
            }];
            
            const layout = {
                title: 'Importancia Relativa de Características en KNN',
                xaxis: { 
                    title: 'Importancia',
                    range: [0, 0.4]
                },
                yaxis: { title: 'Característica' },
                width: 500,
                height: 400
            };
            
            Plotly.newPlot('knn-feature-importance', data, layout);
        }

        // Visualización: KNN con solapamiento
        function crearVisualizacionKNN() {
            // Generar datos más realistas con solapamiento
            const n = 750; // 750 puntos por categoría (1,500 total)
            
            // Categoría Baja (rojo) - Más dispersa y con solapamiento
            const classBaja = {
                x: Array.from({length: n}, () => {
                    const base = Math.random() * 5 + 1; // Rango 1-6
                    return base + (Math.random() - 0.5) * 2; // Más dispersión
                }),
                y: Array.from({length: n}, () => {
                    const base = Math.random() * 5 + 1;
                    return base + (Math.random() - 0.5) * 2;
                }),
                mode: 'markers',
                type: 'scatter',
                name: 'Precio Bajo (750 props)',
                marker: { 
                    color: 'rgba(231, 76, 60, 0.6)', 
                    size: 6,
                    line: { width: 0.5, color: 'rgba(231, 76, 60, 0.8)' }
                },
                text: Array(n).fill('Precio Bajo'),
                hoverinfo: 'text'
            };
            
            // Categoría Alta (azul) - Más dispersa y con solapamiento
            const classAlta = {
                x: Array.from({length: n}, () => {
                    const base = Math.random() * 5 + 4; // Rango 4-9 con solapamiento
                    return base + (Math.random() - 0.5) * 2;
                }),
                y: Array.from({length: n}, () => {
                    const base = Math.random() * 5 + 4;
                    return base + (Math.random() - 0.5) * 2;
                }),
                mode: 'markers',
                type: 'scatter',
                name: 'Precio Alto (750 props)',
                marker: { 
                    color: 'rgba(52, 152, 219, 0.6)', 
                    size: 6,
                    line: { width: 0.5, color: 'rgba(52, 152, 219, 0.8)' }
                },
                text: Array(n).fill('Precio Alto'),
                hoverinfo: 'text'
            };
            
            // Punto de prueba en zona de solapamiento
            const testPoint = {
                x: [4.8],
                y: [4.8],
                mode: 'markers',
                type: 'scatter',
                name: 'Propiedad a Clasificar',
                marker: { 
                    color: '#2ecc71', 
                    size: 20, 
                    symbol: 'star',
                    line: { width: 2, color: 'black' }
                },
                text: ['Nueva Propiedad - Zona de Solapamiento'],
                hoverinfo: 'text'
            };
            
            // Mostrar algunos vecinos cercanos reales
            const neighbors = {
                x: [4.2, 4.5, 5.0, 5.2, 4.9],
                y: [4.3, 4.8, 5.1, 4.7, 5.3],
                mode: 'markers',
                type: 'scatter',
                name: '5 Vecinos Más Cercanos',
                marker: { 
                    color: '#f39c12', 
                    size: 12,
                    symbol: 'circle',
                    line: { width: 2, color: 'white' }
                },
                text: ['Vecino 1', 'Vecino 2', 'Vecino 3', 'Vecino 4', 'Vecino 5'],
                hoverinfo: 'text'
            };
            
            const layout = {
                title: 'Visualización KNN - Proyección Real con Solapamiento',
                xaxis: { 
                    title: 'Característica 1 (Metros + Comuna)',
                    range: [0, 10]
                },
                yaxis: { 
                    title: 'Característica 2 (Baños + Gastos)',
                    range: [0, 10]
                },
                showlegend: true,
                annotations: [{
                    x: 4.8,
                    y: 4.8,
                    text: 'Zona de solapamiento - Clasificación difícil',
                    showarrow: true,
                    arrowhead: 2,
                    ax: 0,
                    ay: -50,
                    bgcolor: 'white',
                    bordercolor: '#2ecc71'
                }],
                width: 500,
                height: 500
            };
            
            Plotly.newPlot('knn-visualization', [classBaja, classAlta, neighbors, testPoint], layout);
        }

        // Visualización: Análisis de K KNN
        function crearAnalisisKKNN() {
            const kValues = [1, 3, 5, 7, 9, 11, 13, 15];
            const accuracy = [0.78, 0.81, 0.83, 0.82, 0.81, 0.80, 0.79, 0.78];
            
            const data = [{
                x: kValues,
                y: accuracy,
                mode: 'lines+markers',
                type: 'scatter',
                name: 'Accuracy del Modelo',
                line: { color: '#3498db', width: 3 },
                marker: { size: 8 }
            }];
            
            // Destacar el K usado en el modelo
            const highlightPoint = {
                x: [modelDataKNN.n_neighbors],
                y: [0.83],
                mode: 'markers',
                type: 'scatter',
                name: 'K Seleccionado (Óptimo)',
                marker: { 
                    color: '#e74c3c', 
                    size: 15,
                    symbol: 'star'
                }
            };
            
            const layout = {
                title: 'Rendimiento según Valor de K',
                xaxis: { 
                    title: 'Número de Vecinos (K)',
                    dtick: 2
                },
                yaxis: { 
                    title: 'Accuracy',
                    tickformat: '.0%'
                },
                showlegend: true,
                annotations: [{
                    x: modelDataKNN.n_neighbors,
                    y: 0.83,
                    text: 'Mejor balance entre bias y varianza',
                    showarrow: true,
                    arrowhead: 2,
                    ax: 0,
                    ay: -40
                }]
            };
            
            Plotly.newPlot('knn-k-analysis', [data[0], highlightPoint], layout);
        }

        // Simular predicción KNN
        function actualizarPrediccionKNN() {
            const metros = parseInt(document.getElementById('knn-metros').value);
            const gastos = parseInt(document.getElementById('knn-gastos').value);
            const habitaciones = parseInt(document.getElementById('knn-habitaciones').value);
            const banos = parseInt(document.getElementById('knn-banos').value);
            const comuna = document.getElementById('knn-comuna').value;
            
            // Simular cálculo de categoría basado en KNN
            let categoria;
            let precioEstimado = metros * 5000 + gastos * 0.1 + banos * 100000 - habitaciones * 20000;
            
            // Ajustar por comuna (simulación)
            const comunaImpacto = {
                'Vitacura': 1.8, 'Lo Barnechea': 1.6, 'Las Condes': 1.5, 'Providencia': 1.4,
                'La Reina': 1.3, 'Ñuñoa': 1.2, 'Macul': 1.0, 'Peñalolén': 0.9,
                'La Florida': 0.8, 'Maipú': 0.8, 'Santiago': 0.7, 'Estación Central': 0.6,
                'Cerrillos': 0.5
            };
            
            const factorComuna = comunaImpacto[comuna] || 1.0;
            precioEstimado *= factorComuna;
            
            // Determinar categoría
            if (precioEstimado > 700000) {
                categoria = "Alta";
            } else if (precioEstimado > 400000) {
                categoria = "Media";
            } else {
                categoria = "Baja";
            }
            
            document.getElementById('knn-prediccion-resultado').textContent = 
                `Categoría estimada: ${categoria} (Precio aprox: $${Math.round(precioEstimado).toLocaleString()})`;
        }

        // ========== INICIALIZACIÓN ==========

        // Inicializar la aplicación
        function inicializarApp() {
            // Actualizar métricas RL
            document.getElementById('rl-precio-promedio').textContent = `$${Math.round(modelDataRL.metricas.precio_promedio).toLocaleString()}`;
            document.getElementById('rl-r2').textContent = modelDataRL.metricas.r2.toFixed(4);
            document.getElementById('rl-mae').textContent = `$${Math.round(modelDataRL.metricas.mae).toLocaleString()}`;
            
            // Actualizar métricas RF
            document.getElementById('rf-precio-promedio').textContent = `$${Math.round(modelDataRF.metricas.precio_promedio).toLocaleString()}`;
            document.getElementById('rf-r2').textContent = modelDataRF.metricas.r2.toFixed(3);
            document.getElementById('rf-mae').textContent = `$${Math.round(modelDataRF.metricas.mae).toLocaleString()}`;
            
            // Actualizar métricas KNN
            document.getElementById('knn-accuracy').textContent = `${(modelDataKNN.metricas.accuracy * 100).toFixed(2)}%`;
            document.getElementById('knn-precision').textContent = `${(modelDataKNN.metricas.precision * 100).toFixed(2)}%`;
            document.getElementById('knn-recall').textContent = `${(modelDataKNN.metricas.recall * 100).toFixed(2)}%`;
            document.getElementById('knn-f1-score').textContent = `${(modelDataKNN.metricas.f1_score * 100).toFixed(2)}%`;
            
            // Inicializar RL
            llenarSelectoresComunasRL();
            actualizarGraficosRL();
            
            // Inicializar valores de los sliders RL
            document.getElementById('rl-metros-value').textContent = `${document.getElementById('rl-metros').value} m²`;
            document.getElementById('rl-gastos-value').textContent = `$${parseInt(document.getElementById('rl-gastos').value).toLocaleString()}`;
            document.getElementById('rl-habitaciones-value').textContent = document.getElementById('rl-habitaciones').value;
            document.getElementById('rl-banos-value').textContent = document.getElementById('rl-banos').value;
            
            // Añadir event listeners a los selectores de comunas RL
            document.getElementById('rl-comuna1').addEventListener('change', actualizarComparadorComunasRL);
            document.getElementById('rl-comuna2').addEventListener('change', actualizarComparadorComunasRL);
            document.getElementById('rl-comuna3').addEventListener('change', actualizarComparadorComunasRL);
            
            // Añadir event listeners a los controles RL
            document.getElementById('rl-metros').addEventListener('input', function() {
                document.getElementById('rl-metros-value').textContent = `${this.value} m²`;
                calcularPrediccionRL();
            });
            
            document.getElementById('rl-gastos').addEventListener('input', function() {
                document.getElementById('rl-gastos-value').textContent = `$${parseInt(this.value).toLocaleString()}`;
                calcularPrediccionRL();
            });
            
            document.getElementById('rl-habitaciones').addEventListener('input', function() {
                document.getElementById('rl-habitaciones-value').textContent = this.value;
                calcularPrediccionRL();
            });
            
            document.getElementById('rl-banos').addEventListener('input', function() {
                document.getElementById('rl-banos-value').textContent = this.value;
                calcularPrediccionRL();
            });
            
            document.getElementById('rl-comuna').addEventListener('change', calcularPrediccionRL);
            
            // Calcular predicción inicial RL
            calcularPrediccionRL();
            
            // Inicializar RF
            llenarSelectoresComunasRF();
            displayNumericImportanceRF();
            displayComunasImportanceRF();
            actualizarGraficosRF();
            
            // Inicializar valores de los sliders RF
            document.getElementById('rf-metros-value').textContent = `${document.getElementById('rf-metros').value} m²`;
            document.getElementById('rf-gastos-value').textContent = `$${parseInt(document.getElementById('rf-gastos').value).toLocaleString()}`;
            document.getElementById('rf-habitaciones-value').textContent = document.getElementById('rf-habitaciones').value;
            document.getElementById('rf-banos-value').textContent = document.getElementById('rf-banos').value;
            
            // Añadir event listeners a los controles RF
            document.getElementById('rf-metros').addEventListener('input', function() {
                document.getElementById('rf-metros-value').textContent = `${this.value} m²`;
                calcularPrediccionRF();
            });
            
            document.getElementById('rf-gastos').addEventListener('input', function() {
                document.getElementById('rf-gastos-value').textContent = `$${parseInt(this.value).toLocaleString()}`;
                calcularPrediccionRF();
            });
            
            document.getElementById('rf-habitaciones').addEventListener('input', function() {
                document.getElementById('rf-habitaciones-value').textContent = this.value;
                calcularPrediccionRF();
            });
            
            document.getElementById('rf-banos').addEventListener('input', function() {
                document.getElementById('rf-banos-value').textContent = this.value;
                calcularPrediccionRF();
            });
            
            document.getElementById('rf-comuna').addEventListener('change', calcularPrediccionRF);
            
            // Calcular predicción inicial RF
            calcularPrediccionRF();
            
            // Inicializar KNN
            llenarSelectoresComunasKNN();
            actualizarGraficosKNN();
            
            // Inicializar valores de los sliders KNN
            document.getElementById('knn-metros-value').textContent = `${document.getElementById('knn-metros').value} m²`;
            document.getElementById('knn-gastos-value').textContent = `$${parseInt(document.getElementById('knn-gastos').value).toLocaleString()}`;
            document.getElementById('knn-habitaciones-value').textContent = document.getElementById('knn-habitaciones').value;
            document.getElementById('knn-banos-value').textContent = document.getElementById('knn-banos').value;
            
            // Añadir event listeners a los controles KNN
            document.getElementById('knn-metros').addEventListener('input', function() {
                document.getElementById('knn-metros-value').textContent = `${this.value} m²`;
                actualizarPrediccionKNN();
            });
            
            document.getElementById('knn-gastos').addEventListener('input', function() {
                document.getElementById('knn-gastos-value').textContent = `$${parseInt(this.value).toLocaleString()}`;
                actualizarPrediccionKNN();
            });
            
            document.getElementById('knn-habitaciones').addEventListener('input', function() {
                document.getElementById('knn-habitaciones-value').textContent = this.value;
                actualizarPrediccionKNN();
            });
            
            document.getElementById('knn-banos').addEventListener('input', function() {
                document.getElementById('knn-banos-value').textContent = this.value;
                actualizarPrediccionKNN();
            });
            
            document.getElementById('knn-comuna').addEventListener('change', actualizarPrediccionKNN);
            
            // Calcular predicción inicial KNN
            actualizarPrediccionKNN();
            
            // Configurar botones de cambio de modelo
            document.getElementById('rl-btn').addEventListener('click', () => switchModel('rl'));
            document.getElementById('rf-btn').addEventListener('click', () => switchModel('rf'));
            document.getElementById('knn-btn').addEventListener('click', () => switchModel('knn'));
        }
        
        // Inicializar la aplicación cuando se carga la página
        document.addEventListener('DOMContentLoaded', inicializarApp);
    </script>
</body>
</html>